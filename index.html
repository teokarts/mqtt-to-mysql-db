<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Database Storage Monitoring</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet" />
    <link rel="stylesheet" href="custom.css" />
  </head>
  <body>
    <div class="container py-2 mb-1">
      <div class="row d-flex top-bar align-items-center">
        <div class="col">
          <h2>Database Storage Monitoring</h2>
        </div>
        <div class="col text-end">
          <div>Database Uptime: <span id="server-time"></span></div>
          <div>Server Uptime: <span id="node-uptime"></span></div>
          <div>Database Size: <span id="db-size"></span> MB</div>
        </div>
      </div>
    </div>

    <div id="panels" class="container panels-container">
      <div class="row g-5">
        <div class="col-md-4">
          <div id="panel1" class="panel">
            <h2>
              Topic: <span class="topic-title">VivusDigester003/Ecu</span>
            </h2>
            <div class="info-box">
              <p>DB Table: <span class="tableName">Loading...</span></p>
              <p>Messages received: <span class="messages">Loading...</span></p>
              <p>Messages stored: <span class="dbInserts">Loading...</span></p>
              <p>Next insert in: <span class="timer">Loading...</span></p>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div id="panel2" class="panel">
            <h2>Topic: <span class="topic-title">Poursalidis/Ecu</span></h2>
            <div class="info-box">
              <p>DB Table: <span class="tableName">Loading...</span></p>
              <p>Messages received: <span class="messages">Loading...</span></p>
              <p>Messages stored: <span class="dbInserts">Loading...</span></p>
              <p>Next insert in: <span class="timer">Loading...</span></p>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div id="panel3" class="panel">
            <h2>
              Topic: <span class="topic-title">VivusTHDigester004/Ecu</span>
            </h2>
            <div class="info-box">
              <p>DB Table: <span class="tableName">Loading...</span></p>
              <p>Messages received: <span class="messages">Loading...</span></p>
              <p>Messages stored: <span class="dbInserts">Loading...</span></p>
              <p>Next insert in: <span class="timer">Loading...</span></p>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div id="panel4" class="panel">
            <h2>Topic: <span class="topic-title">data/tsiap01</span></h2>
            <div class="info-box">
              <p>DB Table: <span class="tableName">Loading...</span></p>
              <p>Messages received: <span class="messages">Loading...</span></p>
              <p>Messages stored: <span class="dbInserts">Loading...</span></p>
              <p>Next insert in: <span class="timer">Loading...</span></p>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div id="panel5" class="panel">
            <h2>Topic: <span class="topic-title">ICR2431/Ch0</span></h2>
            <div class="info-box">
              <p>DB Table: <span class="tableName">Loading...</span></p>
              <p>Messages received: <span class="messages">Loading...</span></p>
              <p>Messages stored: <span class="dbInserts">Loading...</span></p>
              <p>Next insert in: <span class="timer">Loading...</span></p>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div id="panel6" class="panel">
            <h2>Topic: <span class="topic-title">sala001/data</span></h2>
            <div class="info-box">
              <p>DB Table: <span class="tableName">Loading...</span></p>
              <p>Messages received: <span class="messages">Loading...</span></p>
              <p>Messages stored: <span class="dbInserts">Loading...</span></p>
              <p>Next insert in: <span class="timer">Loading...</span></p>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div id="panel7" class="panel">
            <h2>Topic: <span class="topic-title">AirBlock001/data</span></h2>
            <div class="info-box">
              <p>DB Table: <span class="tableName">Loading...</span></p>
              <p>Messages received: <span class="messages">Loading...</span></p>
              <p>Messages stored: <span class="dbInserts">Loading...</span></p>
              <p>Next insert in: <span class="timer">Loading...</span></p>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div id="panel8" class="panel">
            <h2>
              Topic: <span class="topic-title">Agrivoltaics001/data</span>
            </h2>
            <div class="info-box">
              <p>DB Table: <span class="tableName">Loading...</span></p>
              <p>Messages received: <span class="messages">Loading...</span></p>
              <p>Messages stored: <span class="dbInserts">Loading...</span></p>
              <p>Next insert in: <span class="timer">Loading...</span></p>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div id="panel9" class="panel">
            <h2>
              Topic: <span class="topic-title">T004009240001FR/data</span>
            </h2>
            <div class="info-box">
              <p>DB Table: <span class="tableName">Loading...</span></p>
              <p>Messages received: <span class="messages">Loading...</span></p>
              <p>Messages stored: <span class="dbInserts">Loading...</span></p>
              <p>Next insert in: <span class="timer">Loading...</span></p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="table-info" class="container">
      <h2 id="database-table-information" class="table-header mb-3">
        Database Table Information
      </h2>
      <div id="table-info-content"></div>
    </div>

    <script>
      let serverUptimeSeconds = 0;
      let nodeUptimeSeconds = 0;
      let lastServerUpdate = 0;

      function formatTime(milliseconds) {
        if (milliseconds < 0) return '0:00';
        const minutes = Math.floor(milliseconds / 60000);
        const seconds = ((milliseconds % 60000) / 1000).toFixed(0);
        return `${minutes}:${seconds.padStart(2, '0')}`;
      }

      function formatUptime(seconds) {
        const days = Math.floor(seconds / (24 * 3600));
        const hours = Math.floor((seconds % (24 * 3600)) / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const remainingSeconds = Math.floor(seconds % 60);
        return `${days} days ${hours} hours ${minutes} minutes ${remainingSeconds} seconds`;
      }
      function updatePanels(data) {
        data.stats.forEach((stat, index) => {
          const panel = document.getElementById(`panel${index + 1}`);
          if (panel) {
            const tableNameEl = panel.querySelector('.tableName');
            const messagesEl = panel.querySelector('.messages');
            const dbInsertsEl = panel.querySelector('.dbInserts');
            const timerEl = panel.querySelector('.timer');

            // Add or get status element
            let statusEl = panel.querySelector('.status');
            if (!statusEl) {
              statusEl = document.createElement('p');
              statusEl.className = 'status';
              panel.querySelector('.info-box').appendChild(statusEl);
            }

            // Add or get banner element
            let bannerEl = panel.querySelector('.stopped-banner');
            if (!bannerEl) {
              bannerEl = document.createElement('div');
              bannerEl.className = 'stopped-banner';
              bannerEl.textContent = 'STOPPED';
              panel.appendChild(bannerEl);
            }

            if (tableNameEl) tableNameEl.textContent = stat.tableName;
            if (messagesEl) messagesEl.textContent = stat.messageCount;
            if (dbInsertsEl) dbInsertsEl.textContent = stat.dbInsertCount;
            if (timerEl) timerEl.textContent = formatTime(stat.timeRemaining);

            // Update status and panel appearance based on activity
            if (stat.active) {
              statusEl.textContent = '';
              statusEl.style.display = 'none';
              bannerEl.style.display = 'none';
              panel.style.backgroundColor = '#202020'; // normal background
            } else {
              //statusEl.textContent = 'STOPPED';
              statusEl.style.display = 'block';
              bannerEl.style.display = 'block';
              statusEl.style.color = 'red';
              statusEl.style.fontWeight = 'bold';
              panel.style.backgroundColor = '#3a1717'; // darker red background
            }
          }
        });
      }

      function formatDate(dateString) {
        if (!dateString) return '';

        // Split the ISO string into its components
        const match = dateString.match(
          /(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})/
        );
        if (!match) return dateString;

        // Extract components [year, month, day, hour, minute, second]
        const [_, year, month, day, hour, minute, second] = match;

        // Add 9 hours to match the database time
        let adjustedHour = (parseInt(hour) + 16) % 24;
        adjustedHour = adjustedHour.toString().padStart(2, '0');

        // Return formatted string
        return `${day}-${month}-${year} ${adjustedHour}:${minute}:${second}`;
      }

      function updateTableInfo(data) {
        const container = document.getElementById('table-info-content');
        if (!data.tableInfo || !data.tableInfo[0]) {
          container.innerHTML = '<p>No table information available</p>';
          return;
        }

        let html =
          '<div class="table-responsive"><table class="table table-dark">';
        html += '<thead><tr>';

        // Only show specific headers
        const displayHeaders = [
          'Table Name',
          'Size (MB)',
          'Row Count',
          'Database',
        ];
        displayHeaders.forEach((header) => {
          html += `<th>${header}</th>`;
        });
        html += '</tr></thead><tbody>';

        // Add rows for each database's tables
        data.tableInfo.forEach((dbTables) => {
          dbTables.forEach((row) => {
            html += '<tr>';
            displayHeaders.forEach((header) => {
              html += `<td>${row[header]}</td>`;
            });
            html += '</tr>';
          });
        });

        html += '</tbody></table></div>';
        container.innerHTML = html;
      }

      async function fetchAndUpdateData() {
        try {
          const response = await fetch('/data');
          const data = await response.json();
          updatePanels(data);
        } catch (error) {
          console.error('Error fetching data:', error);
        }
      }

      async function fetchAndUpdateTableInfo() {
        try {
          const response = await fetch('/table-info');
          const data = await response.json();
          updateTableInfo(data);
        } catch (error) {
          console.error('Error fetching table info:', error);
        }
      }

      async function updateServerTime() {
        try {
          const response = await fetch('/uptime');
          const data = await response.json();
          if (data.uptimeSeconds) {
            serverUptimeSeconds = parseInt(data.uptimeSeconds, 10);
            lastServerUpdate = Date.now();
            document.getElementById('server-time').textContent = data.uptime;
          }
        } catch (error) {
          console.error('Error fetching server uptime:', error);
        }
      }

      async function updateNodeUptime() {
        try {
          const response = await fetch('/node-uptime');
          const data = await response.json();
          if (data.uptimeSeconds) {
            nodeUptimeSeconds = parseInt(data.uptimeSeconds, 10);
          }
          document.getElementById('node-uptime').textContent = data.uptime;
        } catch (error) {
          console.error('Error fetching node uptime:', error);
        }
      }

      async function updateDatabaseSize() {
        try {
          const response = await fetch('/database-size');
          const data = await response.json();
          document.getElementById('db-size').textContent = data.databaseSize;
        } catch (error) {
          console.error('Error fetching database size:', error);
        }
      }

      // Update uptime displays every second
      setInterval(() => {
        // Only increment if we've received an initial value
        if (serverUptimeSeconds > 0) {
          const timeSinceLastUpdate = Math.floor(
            (Date.now() - lastServerUpdate) / 1000
          );
          const currentUptime = serverUptimeSeconds + timeSinceLastUpdate;
          document.getElementById('server-time').textContent =
            formatUptime(currentUptime);
        }

        if (nodeUptimeSeconds > 0) {
          nodeUptimeSeconds++;
          document.getElementById('node-uptime').textContent =
            formatUptime(nodeUptimeSeconds);
        }
      }, 1000);

      // Initial fetch
      fetchAndUpdateData();
      fetchAndUpdateTableInfo();
      updateServerTime();
      updateNodeUptime();
      updateDatabaseSize();

      // Set up intervals for periodic updates
      setInterval(fetchAndUpdateData, 1000); // Update panels every second
      setInterval(fetchAndUpdateTableInfo, 60000); // Update table info every minute
      setInterval(() => {
        updateServerTime();
        updateNodeUptime();
      }, 60000); // Sync real uptime values every minute
      setInterval(updateDatabaseSize, 300000); // Update database size every 5 minutes
    </script>
  </body>
</html>
